{% extends "base.html" %}

{% block title %}Review Recommendations - SpendSense{% endblock %}

{% block content %}
<div class="review-page">
    <h2>Flagged Recommendations Review Queue</h2>
    <p class="review-description">Only recommendations that have been flagged for review are shown here. Flag recommendations from individual user pages to add them to this queue.</p>
    
    {% if recommendations %}
        {% for rec in recommendations %}
        <div class="recommendation-review-card">
            <div class="review-header">
                <div class="review-meta">
                    <h3>{{ rec.type|title }} Recommendation</h3>
                    <p>
                        <strong>User:</strong> <a href="/users/{{ rec.user_id }}">{{ rec.user_id }}</a> |
                        <strong>Status:</strong> <span class="badge badge-{{ rec.status }}">{{ rec.status|title }}</span> |
                        <strong>Persona:</strong> {{ rec.persona or "N/A" }} |
                        <strong>Created:</strong> {{ rec.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    </p>
                </div>
            </div>
            
            <div class="review-content">
                <h4>Content:</h4>
                <div class="content-box">{{ rec.content|markdown|safe }}</div>
                
                <h4>⭐ Rationale:</h4>
                <div class="rationale-box">{{ rec.rationale }}</div>
                
                <!-- Decision Trace - CRITICAL REQUIREMENT -->
                {% if rec.decision_trace %}
                <details class="decision-trace">
                    <summary><strong>⭐ Decision Trace (Why this recommendation was made)</strong></summary>
                    <div class="trace-content">
                        <h5>Persona Assignment:</h5>
                        <p><strong>Persona:</strong> {{ rec.decision_trace.persona_assigned }}</p>
                        <p><strong>Reasoning:</strong> {{ rec.decision_trace.persona_reasoning }}</p>
                        
                        {% if rec.decision_trace.triggered_signals %}
                        <h5>⭐ Signal That Triggered This Recommendation:</h5>
                        <p><strong>Signal ID(s):</strong> {{ rec.decision_trace.triggered_signals|join(', ') if rec.decision_trace.triggered_signals is iterable and rec.decision_trace.triggered_signals is not string else rec.decision_trace.triggered_signals }}</p>
                        {% if rec.decision_trace.input_signals and rec.decision_trace.input_signals.triggered_signal %}
                        <p><strong>Signal Name:</strong> {{ rec.decision_trace.input_signals.signal_name }}</p>
                        {% endif %}
                        {% if rec.decision_trace.signal_context %}
                        <h6>Signal Context:</h6>
                        <pre>{{ rec.decision_trace.signal_context|tojson }}</pre>
                        {% endif %}
                        {% elif rec.decision_trace.input_signals and rec.decision_trace.input_signals.persona_signals %}
                        <h5>Persona-Based Recommendation (No Specific Signal):</h5>
                        <p><em>This recommendation was generated based on persona assignment, not a specific signal trigger.</em></p>
                        <h5>Persona Signals Used:</h5>
                        <pre>{{ rec.decision_trace.input_signals.persona_signals|tojson }}</pre>
                        {% elif rec.decision_trace.input_signals %}
                        <h5>Signals Used:</h5>
                        <pre>{{ rec.decision_trace.input_signals|tojson }}</pre>
                        {% endif %}
                        
                        {% if rec.decision_trace.base_data %}
                        <h5>⭐ User Data That Generated These Signals:</h5>
                        <div class="base-data-section">
                            {% if rec.decision_trace.base_data.accounts %}
                            <h6>Accounts:</h6>
                            <pre>{{ rec.decision_trace.base_data.accounts|tojson }}</pre>
                            {% endif %}
                            
                            {% if rec.decision_trace.base_data.transactions %}
                            <h6>Transactions ({{ rec.decision_trace.base_data.transactions|length }}):</h6>
                            <pre>{{ rec.decision_trace.base_data.transactions|tojson }}</pre>
                            {% endif %}
                            
                            {% if rec.decision_trace.base_data.liabilities %}
                            <h6>Liabilities:</h6>
                            <pre>{{ rec.decision_trace.base_data.liabilities|tojson }}</pre>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if rec.decision_trace.offer_id %}
                        <h5>Offer ID:</h5>
                        <p>{{ rec.decision_trace.offer_id }}</p>
                        {% endif %}
                        
                        {% if rec.decision_trace.variables_inserted %}
                        <h5>Variables Inserted:</h5>
                        <pre>{{ rec.decision_trace.variables_inserted|tojson }}</pre>
                        {% endif %}
                        
                        {% if rec.decision_trace.eligibility_checks %}
                        <h5>Eligibility Checks:</h5>
                        <pre>{{ rec.decision_trace.eligibility_checks|tojson }}</pre>
                        {% endif %}
                    </div>
                </details>
                {% endif %}
                
                <!-- Review Actions - CRITICAL REQUIREMENT -->
                <div class="review-actions">
                    {% if rec.status == "flagged" %}
                    <!-- Approve Button -->
                    <div class="action-form" data-recommendation-id="{{ rec.recommendation_id }}">
                        <div class="form-group">
                            <label for="notes_{{ rec.recommendation_id }}">Notes (optional):</label>
                            <input type="text" id="notes_{{ rec.recommendation_id }}" name="notes" placeholder="Optional notes" class="approve-notes-input">
                        </div>
                        <button type="button" class="btn btn-success approve-btn">⭐ Approve</button>
                    </div>
                    
                    <!-- Override/Reject Button -->
                    <div class="action-form" data-recommendation-id="{{ rec.recommendation_id }}">
                        <div class="form-group">
                            <label for="reason_{{ rec.recommendation_id }}">Reason (required):</label>
                            <input type="text" id="reason_{{ rec.recommendation_id }}" name="reason" required placeholder="Reason for override" class="reject-reason-input">
                        </div>
                        <button type="button" class="btn btn-danger reject-btn">⭐ Override/Reject</button>
                    </div>
                    {% endif %}
                    
                    <a href="/users/{{ rec.user_id }}" class="btn btn-secondary">View User</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="empty-state">No flagged recommendations found. Flag recommendations from user pages to add them to the review queue.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle approve button clicks
    const approveButtons = document.querySelectorAll('.approve-btn');
    
    approveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const form = this.closest('.action-form');
            const recommendationId = form.getAttribute('data-recommendation-id');
            const notesInput = form.querySelector('.approve-notes-input');
            const notes = notesInput ? notesInput.value : '';
            const buttonElement = this;
            const card = form.closest('.recommendation-review-card');
            
            // Disable button
            buttonElement.disabled = true;
            buttonElement.textContent = '⏳ Approving...';
            
            // Approve the recommendation via fetch
            const formData = new URLSearchParams();
            if (notes) {
                formData.append('notes', notes);
            }
            
            fetch(`/approve/${recommendationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: formData.toString(),
                redirect: 'manual'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status >= 300 && response.status < 400) {
                    return { success: true };
                } else {
                    throw new Error('Failed to approve recommendation');
                }
            })
            .then(data => {
                if (data && data.success !== false) {
                    // Animate card removal with slide-up effect
                    const cardHeight = card.offsetHeight;
                    const cardMargin = parseInt(window.getComputedStyle(card).marginBottom) || 0;
                    
                    // Add transition for smooth slide-up and fade
                    card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, max-height 0.3s ease-out, margin-bottom 0.3s ease-out';
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(-10px) scale(0.95)';
                    card.style.maxHeight = cardHeight + 'px';
                    card.style.overflow = 'hidden';
                    card.style.marginBottom = '0';
                    
                    // Collapse the card height
                    setTimeout(() => {
                        card.style.maxHeight = '0';
                        card.style.paddingTop = '0';
                        card.style.paddingBottom = '0';
                    }, 50);
                    
                    // Remove card after animation completes
                    setTimeout(() => {
                        card.remove();
                    }, 350);
                } else {
                    throw new Error(data.error || 'Failed to approve recommendation');
                }
            })
            .catch(error => {
                console.error('Error approving recommendation:', error);
                buttonElement.disabled = false;
                buttonElement.textContent = '⭐ Approve';
                alert('Failed to approve recommendation. Please try again.');
            });
        });
    });
    
    // Handle reject button clicks
    const rejectButtons = document.querySelectorAll('.reject-btn');
    
    rejectButtons.forEach(button => {
        button.addEventListener('click', function() {
            const form = this.closest('.action-form');
            const recommendationId = form.getAttribute('data-recommendation-id');
            const reasonInput = form.querySelector('.reject-reason-input');
            const reason = reasonInput ? reasonInput.value.trim() : '';
            const buttonElement = this;
            const card = form.closest('.recommendation-review-card');
            
            // Validate reason
            if (!reason) {
                alert('Please provide a reason for rejecting this recommendation.');
                reasonInput.focus();
                return;
            }
            
            // Disable button
            buttonElement.disabled = true;
            buttonElement.textContent = '⏳ Rejecting...';
            
            // Reject the recommendation via fetch
            const formData = new URLSearchParams();
            formData.append('reason', reason);
            
            fetch(`/override/${recommendationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: formData.toString(),
                redirect: 'manual'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status >= 300 && response.status < 400) {
                    return { success: true };
                } else {
                    throw new Error('Failed to reject recommendation');
                }
            })
            .then(data => {
                if (data && data.success !== false) {
                    // Animate card removal with slide-up effect
                    const cardHeight = card.offsetHeight;
                    const cardMargin = parseInt(window.getComputedStyle(card).marginBottom) || 0;
                    
                    // Add transition for smooth slide-up and fade
                    card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, max-height 0.3s ease-out, margin-bottom 0.3s ease-out';
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(-10px) scale(0.95)';
                    card.style.maxHeight = cardHeight + 'px';
                    card.style.overflow = 'hidden';
                    card.style.marginBottom = '0';
                    
                    // Collapse the card height
                    setTimeout(() => {
                        card.style.maxHeight = '0';
                        card.style.paddingTop = '0';
                        card.style.paddingBottom = '0';
                    }, 50);
                    
                    // Remove card after animation completes
                    setTimeout(() => {
                        card.remove();
                    }, 350);
                } else {
                    throw new Error(data.error || 'Failed to reject recommendation');
                }
            })
            .catch(error => {
                console.error('Error rejecting recommendation:', error);
                buttonElement.disabled = false;
                buttonElement.textContent = '⭐ Override/Reject';
                alert('Failed to reject recommendation. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}

