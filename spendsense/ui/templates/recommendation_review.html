{% extends "base.html" %}

{% block title %}Review Recommendations - SpendSense{% endblock %}

{% block content %}
<div class="review-page">
    <h2>Flagged Recommendations Review Queue</h2>
    <p class="review-description">Only recommendations that have been flagged for review are shown here. Flag recommendations from individual user pages to add them to this queue.</p>
    
    {% if recommendations %}
        {% for rec in recommendations %}
        <div class="recommendation-review-card">
            <div class="review-header">
                <div class="review-meta">
                    <h3>{{ rec.type|title }} Recommendation</h3>
                    <p>
                        <strong>User:</strong> <a href="/users/{{ rec.user_id }}">{{ rec.user_id }}</a> |
                        <strong>Status:</strong> <span class="badge badge-{{ rec.status }}">{{ rec.status|title }}</span> |
                        <strong>Persona:</strong> {{ rec.persona or "N/A" }} |
                        <strong>Created:</strong> {{ rec.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    </p>
                </div>
            </div>
            
            <div class="review-content">
                <h4>Content:</h4>
                <div class="content-box">{{ rec.content|safe }}</div>
                
                <h4>⭐ Rationale:</h4>
                <div class="rationale-box">{{ rec.rationale }}</div>
                
                <!-- Decision Trace - CRITICAL REQUIREMENT -->
                {% if rec.decision_trace %}
                <details class="decision-trace">
                    <summary><strong>⭐ Decision Trace (Why this recommendation was made)</strong></summary>
                    <div class="trace-content">
                        <h5>Persona Assignment:</h5>
                        <p><strong>Persona:</strong> {{ rec.decision_trace.persona_assigned }}</p>
                        <p><strong>Reasoning:</strong> {{ rec.decision_trace.persona_reasoning }}</p>
                        
                        {% if rec.decision_trace.input_signals and rec.decision_trace.input_signals.persona_signals %}
                        <h5>Signals That Triggered This Recommendation:</h5>
                        <pre>{{ rec.decision_trace.input_signals.persona_signals|tojson }}</pre>
                        {% elif rec.decision_trace.input_signals %}
                        <h5>Signals That Triggered This Recommendation:</h5>
                        <pre>{{ rec.decision_trace.input_signals|tojson }}</pre>
                        {% endif %}
                        
                        {% if rec.decision_trace.base_data %}
                        <h5>⭐ User Data That Generated These Signals:</h5>
                        <div class="base-data-section">
                            {% if rec.decision_trace.base_data.accounts %}
                            <h6>Accounts:</h6>
                            <pre>{{ rec.decision_trace.base_data.accounts|tojson }}</pre>
                            {% endif %}
                            
                            {% if rec.decision_trace.base_data.transactions %}
                            <h6>Transactions ({{ rec.decision_trace.base_data.transactions|length }}):</h6>
                            <pre>{{ rec.decision_trace.base_data.transactions|tojson }}</pre>
                            {% endif %}
                            
                            {% if rec.decision_trace.base_data.liabilities %}
                            <h6>Liabilities:</h6>
                            <pre>{{ rec.decision_trace.base_data.liabilities|tojson }}</pre>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if rec.decision_trace.offer_id %}
                        <h5>Offer ID:</h5>
                        <p>{{ rec.decision_trace.offer_id }}</p>
                        {% endif %}
                        
                        {% if rec.decision_trace.variables_inserted %}
                        <h5>Variables Inserted:</h5>
                        <pre>{{ rec.decision_trace.variables_inserted|tojson }}</pre>
                        {% endif %}
                        
                        {% if rec.decision_trace.eligibility_checks %}
                        <h5>Eligibility Checks:</h5>
                        <pre>{{ rec.decision_trace.eligibility_checks|tojson }}</pre>
                        {% endif %}
                    </div>
                </details>
                {% endif %}
                
                <!-- Review Actions - CRITICAL REQUIREMENT -->
                <div class="review-actions">
                    {% if rec.status == "flagged" %}
                    <!-- Approve Button -->
                    <form method="post" action="/approve/{{ rec.recommendation_id }}" class="action-form">
                        <div class="form-group">
                            <label for="notes_{{ rec.recommendation_id }}">Notes (optional):</label>
                            <input type="text" id="notes_{{ rec.recommendation_id }}" name="notes" placeholder="Optional notes">
                        </div>
                        <button type="submit" class="btn btn-success">⭐ Approve</button>
                    </form>
                    
                    <!-- Override/Reject Button -->
                    <form method="post" action="/override/{{ rec.recommendation_id }}" class="action-form">
                        <div class="form-group">
                            <label for="reason_{{ rec.recommendation_id }}">Reason (required):</label>
                            <input type="text" id="reason_{{ rec.recommendation_id }}" name="reason" required placeholder="Reason for override">
                        </div>
                        <button type="submit" class="btn btn-danger">⭐ Override/Reject</button>
                    </form>
                    {% endif %}
                    
                    <a href="/recommendation/{{ rec.recommendation_id }}" class="btn btn-secondary">View Full Details</a>
                    <a href="/users/{{ rec.user_id }}" class="btn btn-secondary">View User</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="empty-state">No flagged recommendations found. Flag recommendations from user pages to add them to the review queue.</p>
    {% endif %}
</div>
{% endblock %}

