{% extends "base.html" %}

{% block title %}User Detail - {{ user_detail.user.user_id }} - SpendSense{% endblock %}

{% block content %}
<div class="user-detail">
    <div class="user-header">
        <h2>User Detail: {{ user_detail.user.user_id }}</h2>
        <a href="/users" class="btn btn-secondary">‚Üê Back to Users</a>
    </div>
    
    <!-- User Information Section -->
    <section class="section">
        <h3>User Information</h3>
        <div class="info-grid">
            <div class="info-item">
                <label>Name:</label>
                <span>{{ user_detail.user.name or "N/A" }}</span>
            </div>
            <div class="info-item">
                <label>Email:</label>
                <span>{{ user_detail.user.email or "N/A" }}</span>
            </div>
            <div class="info-item">
                <label>Consent Status:</label>
                {% if user_detail.user.consent_status %}
                    <span class="badge badge-success">Consented</span>
                {% else %}
                    <span class="badge badge-error">Not Consented</span>
                {% endif %}
            </div>
            <div class="info-item">
                <label>Consent Timestamp:</label>
                <span>{{ user_detail.user.consent_timestamp.strftime('%Y-%m-%d %H:%M:%S') if user_detail.user.consent_timestamp else "N/A" }}</span>
            </div>
        </div>
    </section>
    
    <!-- Signals Display - CRITICAL REQUIREMENT -->
    <section class="section">
        <h3>‚≠ê Detected Signals</h3>
        
        <!-- 30-Day Signals -->
        <div class="signals-section">
            <h4>30-Day Signals</h4>
            <div class="signals-grid">
                <div class="signal-card">
                    <h5>Subscriptions</h5>
                    <ul>
                        <li>Recurring Merchants: <strong>{{ user_detail.signals_30d.subscriptions.recurring_merchant_count }}</strong></li>
                        <li>Monthly Recurring Spend: <strong>${{ "%.2f"|format(user_detail.signals_30d.subscriptions.monthly_recurring_spend) }}</strong></li>
                        <li>Subscription Share: <strong>{{ "%.1f"|format(user_detail.signals_30d.subscriptions.subscription_share_percent) }}%</strong></li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Savings</h5>
                    <ul>
                        <li>Net Inflow: <strong>${{ "%.2f"|format(user_detail.signals_30d.savings.net_inflow) }}</strong></li>
                        <li>Growth Rate: <strong>{{ "%.1f"|format(user_detail.signals_30d.savings.growth_rate_percent) }}%</strong></li>
                        <li>Emergency Fund Months: <strong>{{ "%.1f"|format(user_detail.signals_30d.savings.emergency_fund_months) }}</strong></li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Credit</h5>
                    <ul>
                        <li>Number of Credit Cards: <strong>{{ user_detail.signals_30d.credit.num_credit_cards }}</strong></li>
                        <li>Max Utilization: 
                            <strong>{{ "%.1f"|format(user_detail.signals_30d.credit.max_utilization_percent) }}%</strong>
                        </li>
                        <li>Flags: 
                            {% set util_30d = user_detail.signals_30d.credit.max_utilization_percent %}
                            {% set bold_30 = util_30d >= 30 and util_30d < 50 %}
                            {% set bold_50 = util_30d >= 50 and util_30d < 80 %}
                            {% set bold_80 = util_30d >= 80 %}
                            <span class="badge {{ 'badge-warning' if user_detail.signals_30d.credit.flag_30_percent else 'badge-inactive' }} {% if bold_30 %}utilization-flag-bold{% endif %}">30%</span>
                            <span class="badge {{ 'badge-warning' if user_detail.signals_30d.credit.flag_50_percent else 'badge-inactive' }} {% if bold_50 %}utilization-flag-bold{% endif %}">50%</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_30d.credit.flag_80_percent else 'badge-inactive' }} {% if bold_80 %}utilization-flag-bold{% endif %}">80%</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_30d.credit.is_overdue else 'badge-inactive' }}">Overdue</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_30d.credit.minimum_payment_only else 'badge-inactive' }}">Minimum Payment Only</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_30d.credit.interest_charges_present else 'badge-inactive' }}">Interest Charges</span>
                        </li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Income</h5>
                    <ul>
                        <li>Payroll Detected: <strong>{{ "Yes" if user_detail.signals_30d.income.payroll_detected else "No" }}</strong></li>
                        <li>Payment Frequency: <strong>{{ (user_detail.signals_30d.income.payment_frequency or "N/A")|title }}</strong></li>
                        <li>Cash Flow Buffer: <strong>{{ "%.1f"|format(user_detail.signals_30d.income.cash_flow_buffer_months) }} months</strong></li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Loans</h5>
                    {% if user_detail.signals_30d.loans.has_mortgage or user_detail.signals_30d.loans.has_student_loan %}
                        {% set monthly_income_30d = 0.0 %}
                        {% set annual_income_30d = 0.0 %}
                        {% if user_detail.signals_30d.income.payroll_detected and user_detail.signals_30d.income.total_income > 0 %}
                            {% set monthly_income_30d = user_detail.signals_30d.income.total_income %}
                            {% set annual_income_30d = monthly_income_30d * 12 %}
                        {% endif %}
                        
                        <ul>
                            {% if user_detail.signals_30d.loans.has_mortgage %}
                                <li><strong>Mortgage</strong></li>
                                {% if annual_income_30d > 0 %}
                                    {% set mortgage_balance_to_income = user_detail.signals_30d.loans.mortgage_balance / annual_income_30d %}
                                    {% set mortgage_payment_burden = (user_detail.signals_30d.loans.mortgage_monthly_payment / monthly_income_30d * 100) if monthly_income_30d > 0 else 0.0 %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>{{ "%.2f"|format(mortgage_balance_to_income) }}x</strong></li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>{{ "%.1f"|format(mortgage_payment_burden) }}%</strong></li>
                                {% else %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>N/A</strong> (no income)</li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>N/A</strong> (no income)</li>
                                {% endif %}
                            {% endif %}
                            
                            {% if user_detail.signals_30d.loans.has_student_loan %}
                                <li><strong>Student Loans</strong></li>
                                {% if annual_income_30d > 0 %}
                                    {% set student_loan_balance_to_income = user_detail.signals_30d.loans.student_loan_balance / annual_income_30d %}
                                    {% set student_loan_payment_burden = (user_detail.signals_30d.loans.student_loan_monthly_payment / monthly_income_30d * 100) if monthly_income_30d > 0 else 0.0 %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>{{ "%.2f"|format(student_loan_balance_to_income) }}x</strong></li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>{{ "%.1f"|format(student_loan_payment_burden) }}%</strong></li>
                                {% else %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>N/A</strong> (no income)</li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>N/A</strong> (no income)</li>
                                {% endif %}
                            {% endif %}
                            
                            {% if user_detail.signals_30d.loans.any_loan_overdue %}
                                <li>Status: <span class="badge badge-error">Overdue</span></li>
                            {% endif %}
                        </ul>
                    {% else %}
                        <ul>
                            <li>No loans detected</li>
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 180-Day Signals -->
        <div class="signals-section">
            <h4>180-Day Signals</h4>
            <div class="signals-grid">
                <div class="signal-card">
                    <h5>Subscriptions</h5>
                    <ul>
                        <li>Recurring Merchants: <strong>{{ user_detail.signals_180d.subscriptions.recurring_merchant_count }}</strong></li>
                        <li>Monthly Recurring Spend: <strong>${{ "%.2f"|format(user_detail.signals_180d.subscriptions.monthly_recurring_spend) }}</strong></li>
                        <li>Subscription Share: <strong>{{ "%.1f"|format(user_detail.signals_180d.subscriptions.subscription_share_percent) }}%</strong></li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Savings</h5>
                    <ul>
                        <li>Net Inflow: <strong>${{ "%.2f"|format(user_detail.signals_180d.savings.net_inflow) }}</strong></li>
                        <li>Growth Rate: <strong>{{ "%.1f"|format(user_detail.signals_180d.savings.growth_rate_percent) }}%</strong></li>
                        <li>Emergency Fund Months: <strong>{{ "%.1f"|format(user_detail.signals_180d.savings.emergency_fund_months) }}</strong></li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Credit</h5>
                    <ul>
                        <li>Number of Credit Cards: <strong>{{ user_detail.signals_180d.credit.num_credit_cards }}</strong></li>
                        <li>Max Utilization: 
                            <strong>{{ "%.1f"|format(user_detail.signals_180d.credit.max_utilization_percent) }}%</strong>
                        </li>
                        <li>Flags: 
                            {% set util_180d = user_detail.signals_180d.credit.max_utilization_percent %}
                            {% set bold_30 = util_180d >= 30 and util_180d < 50 %}
                            {% set bold_50 = util_180d >= 50 and util_180d < 80 %}
                            {% set bold_80 = util_180d >= 80 %}
                            <span class="badge {{ 'badge-warning' if user_detail.signals_180d.credit.flag_30_percent else 'badge-inactive' }} {% if bold_30 %}utilization-flag-bold{% endif %}">30%</span>
                            <span class="badge {{ 'badge-warning' if user_detail.signals_180d.credit.flag_50_percent else 'badge-inactive' }} {% if bold_50 %}utilization-flag-bold{% endif %}">50%</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_180d.credit.flag_80_percent else 'badge-inactive' }} {% if bold_80 %}utilization-flag-bold{% endif %}">80%</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_180d.credit.is_overdue else 'badge-inactive' }}">Overdue</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_180d.credit.minimum_payment_only else 'badge-inactive' }}">Minimum Payment Only</span>
                            <span class="badge {{ 'badge-error' if user_detail.signals_180d.credit.interest_charges_present else 'badge-inactive' }}">Interest Charges</span>
                        </li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Income</h5>
                    <ul>
                        <li>Payroll Detected: <strong>{{ "Yes" if user_detail.signals_180d.income.payroll_detected else "No" }}</strong></li>
                        <li>Payment Frequency: <strong>{{ (user_detail.signals_180d.income.payment_frequency or "N/A")|title }}</strong></li>
                        <li>Cash Flow Buffer: <strong>{{ "%.1f"|format(user_detail.signals_180d.income.cash_flow_buffer_months) }} months</strong></li>
                    </ul>
                </div>
                
                <div class="signal-card">
                    <h5>Loans</h5>
                    {% if user_detail.signals_180d.loans.has_mortgage or user_detail.signals_180d.loans.has_student_loan %}
                        {% set monthly_income_180d = 0.0 %}
                        {% set annual_income_180d = 0.0 %}
                        {% if user_detail.signals_180d.income.payroll_detected and user_detail.signals_180d.income.total_income > 0 %}
                            {% set monthly_income_180d = (user_detail.signals_180d.income.total_income / 180) * 30 %}
                            {% set annual_income_180d = monthly_income_180d * 12 %}
                        {% endif %}
                        
                        <ul>
                            {% if user_detail.signals_180d.loans.has_mortgage %}
                                <li><strong>Mortgage</strong></li>
                                {% if annual_income_180d > 0 %}
                                    {% set mortgage_balance_to_income = user_detail.signals_180d.loans.mortgage_balance / annual_income_180d %}
                                    {% set mortgage_payment_burden = (user_detail.signals_180d.loans.mortgage_monthly_payment / monthly_income_180d * 100) if monthly_income_180d > 0 else 0.0 %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>{{ "%.2f"|format(mortgage_balance_to_income) }}x</strong></li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>{{ "%.1f"|format(mortgage_payment_burden) }}%</strong></li>
                                {% else %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>N/A</strong> (no income)</li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>N/A</strong> (no income)</li>
                                {% endif %}
                            {% endif %}
                            
                            {% if user_detail.signals_180d.loans.has_student_loan %}
                                <li><strong>Student Loans</strong></li>
                                {% if annual_income_180d > 0 %}
                                    {% set student_loan_balance_to_income = user_detail.signals_180d.loans.student_loan_balance / annual_income_180d %}
                                    {% set student_loan_payment_burden = (user_detail.signals_180d.loans.student_loan_monthly_payment / monthly_income_180d * 100) if monthly_income_180d > 0 else 0.0 %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>{{ "%.2f"|format(student_loan_balance_to_income) }}x</strong></li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>{{ "%.1f"|format(student_loan_payment_burden) }}%</strong></li>
                                {% else %}
                                    <li style="margin-left: 1em;">Balance-to-Income Ratio: <strong>N/A</strong> (no income)</li>
                                    <li style="margin-left: 1em;">Payment Burden: <strong>N/A</strong> (no income)</li>
                                {% endif %}
                            {% endif %}
                            
                            {% if user_detail.signals_180d.loans.any_loan_overdue %}
                                <li>Status: <span class="badge badge-error">Overdue</span></li>
                            {% endif %}
                        </ul>
                    {% else %}
                        <ul>
                            <li>No loans detected</li>
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
    
    <!-- Persona History Section - CRITICAL REQUIREMENT -->
    <section class="section">
        <h3>‚≠ê Persona Assignments (30d & 180d)</h3>
        
        {% if user_detail.persona_history %}
            <div class="persona-history">
                <table class="persona-table">
                    <thead>
                        <tr>
                            <th>Window</th>
                            <th>Persona</th>
                            <th>Assigned At</th>
                            <th>Signals Used</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ph in user_detail.persona_history %}
                        <tr class="{% if ph.is_primary %}primary-persona{% endif %}">
                            <td>
                                <strong>{{ ph.window_days }}d</strong>
                                {% if ph.is_primary %}
                                    <span class="badge badge-primary">PRIMARY</span>
                                {% elif ph.is_secondary %}
                                    <span class="badge badge-secondary">SECONDARY</span>
                                {% endif %}
                            </td>
                            <td><span class="badge badge-persona">{{ ph.persona }}</span></td>
                            <td>{{ ph.assigned_at[:19] }}</td>
                            <td>
                                {% if ph.signals_formatted %}
                                    <ul class="signals-list">
                                        {% for signal in ph.signals_formatted %}
                                        <li>{{ signal }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">No signals available</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="empty-state">No persona history available</p>
        {% endif %}
    </section>
    
    <!-- Recommendations Section - CRITICAL REQUIREMENT -->
    <section class="section">
        <h3>‚≠ê Recommendations with Rationales</h3>
        
        {% if user_detail.recommendations %}
            {% set offers = user_detail.recommendations | selectattr("type", "equalto", "offer") | list %}
            {% set education = user_detail.recommendations | selectattr("type", "equalto", "education") | list %}
            
            <!-- Partner Offers Section -->
            {% if offers %}
            <div class="offers-section">
                <h4>üíº Partner Offers</h4>
                
                {% for rec in offers %}
                <div class="recommendation-card">
                    <div class="recommendation-header">
                        <h4>{{ rec.type|title }} Recommendation</h4>
                        {% if rec.status == "pending" %}
                        <button type="button" class="btn btn-warning btn-sm flag-btn" data-recommendation-id="{{ rec.recommendation_id }}">üö© Flag for Review</button>
                        {% elif rec.status == "approved" or rec.status == "rejected" %}
                        <div class="status-actions">
                            <span class="badge badge-{{ rec.status }}">{{ rec.status|title }}</span>
                            <button type="button" class="btn btn-warning btn-sm unflag-btn" data-recommendation-id="{{ rec.recommendation_id }}">üîÑ Flag for Review</button>
                        </div>
                        {% else %}
                        <span class="badge badge-{{ rec.status }}">{{ rec.status|title }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="recommendation-content">
                        <h5>Content:</h5>
                        <div class="content-box">{{ rec.content|markdown|safe }}</div>
                        
                        <h5>‚≠ê Rationale:</h5>
                        <div class="rationale-box">{{ rec.rationale }}</div>
                        
                        {% if rec.status == "rejected" and rec.operator_notes %}
                        <h5>Rejection Reason:</h5>
                        <div class="rejection-reason-box">
                            {% if rec.operator_notes.startswith("Override reason: ") %}
                                {{ rec.operator_notes[17:] }}
                            {% else %}
                                {{ rec.operator_notes }}
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Decision Trace - CRITICAL REQUIREMENT -->
                        {% if rec.decision_trace %}
                        <details class="decision-trace">
                            <summary><strong>Decision Trace (Why this recommendation was made)</strong></summary>
                            <div class="trace-content">
                                {% if rec.decision_trace.triggered_signals %}
                                <h6>‚≠ê Signal That Triggered This Recommendation:</h6>
                                <p><strong>Signal ID(s):</strong> {{ rec.decision_trace.triggered_signals|join(', ') if rec.decision_trace.triggered_signals is iterable and rec.decision_trace.triggered_signals is not string else rec.decision_trace.triggered_signals }}</p>
                                {% if rec.decision_trace.input_signals and rec.decision_trace.input_signals.triggered_signal %}
                                <p><strong>Signal Name:</strong> {{ rec.decision_trace.input_signals.signal_name }}</p>
                                {% endif %}
                                {% if rec.decision_trace.signal_context %}
                                <h6>Signal Context:</h6>
                                <pre>{{ rec.decision_trace.signal_context|tojson }}</pre>
                                {% endif %}
                                {% elif rec.decision_trace.input_signals and rec.decision_trace.input_signals.persona_signals %}
                                <h6>Persona-Based Recommendation (No Specific Signal):</h6>
                                <p><em>This recommendation was generated based on persona assignment, not a specific signal trigger.</em></p>
                                <h6>Persona Signals Used:</h6>
                                <pre>{{ rec.decision_trace.input_signals.persona_signals|tojson }}</pre>
                                {% elif rec.decision_trace.input_signals %}
                                <h6>Signals Used:</h6>
                                <pre>{{ rec.decision_trace.input_signals|tojson }}</pre>
                                {% endif %}
                                
                                {% if rec.decision_trace.base_data %}
                                <h6>‚≠ê User Data That Generated These Signals:</h6>
                                <div class="base-data-section">
                                    {% if rec.decision_trace.base_data.accounts %}
                                    <h7>Accounts:</h7>
                                    <pre>{{ rec.decision_trace.base_data.accounts|tojson }}</pre>
                                    {% endif %}
                                    
                                    {% if rec.decision_trace.base_data.transactions %}
                                    <h7>Transactions ({{ rec.decision_trace.base_data.transactions|length }}):</h7>
                                    <pre>{{ rec.decision_trace.base_data.transactions|tojson }}</pre>
                                    {% endif %}
                                    
                                    {% if rec.decision_trace.base_data.liabilities %}
                                    <h7>Liabilities:</h7>
                                    <pre>{{ rec.decision_trace.base_data.liabilities|tojson }}</pre>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                {% if rec.decision_trace.offer_id %}
                                <h6>Offer ID:</h6>
                                <p>{{ rec.decision_trace.offer_id }}</p>
                                {% endif %}
                                
                                {% if rec.decision_trace.variables_inserted %}
                                <h6>Variables Inserted:</h6>
                                <pre>{{ rec.decision_trace.variables_inserted|tojson }}</pre>
                                {% endif %}
                                
                                {% if rec.decision_trace.eligibility_checks %}
                                <h6>Eligibility Checks:</h6>
                                <pre>{{ rec.decision_trace.eligibility_checks|tojson }}</pre>
                                {% endif %}
                            </div>
                        </details>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Educational Materials Section -->
            {% if education %}
            <div class="education-section">
                <h4>üìö Educational Materials</h4>
                
                {% for rec in education %}
                <div class="recommendation-card">
                    <div class="recommendation-header">
                        <h4>{{ rec.type|title }} Recommendation</h4>
                        {% if rec.status == "pending" %}
                        <button type="button" class="btn btn-warning btn-sm flag-btn" data-recommendation-id="{{ rec.recommendation_id }}">üö© Flag for Review</button>
                        {% elif rec.status == "approved" or rec.status == "rejected" %}
                        <div class="status-actions">
                            <span class="badge badge-{{ rec.status }}">{{ rec.status|title }}</span>
                            <button type="button" class="btn btn-warning btn-sm unflag-btn" data-recommendation-id="{{ rec.recommendation_id }}">üîÑ Flag for Review</button>
                        </div>
                        {% else %}
                        <span class="badge badge-{{ rec.status }}">{{ rec.status|title }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="recommendation-content">
                        <h5>Content:</h5>
                        <div class="content-box">{{ rec.content|markdown|safe }}</div>
                        
                        <h5>‚≠ê Rationale:</h5>
                        <div class="rationale-box">{{ rec.rationale }}</div>
                        
                        {% if rec.status == "rejected" and rec.operator_notes %}
                        <h5>Rejection Reason:</h5>
                        <div class="rejection-reason-box">
                            {% if rec.operator_notes.startswith("Override reason: ") %}
                                {{ rec.operator_notes[17:] }}
                            {% else %}
                                {{ rec.operator_notes }}
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Decision Trace - CRITICAL REQUIREMENT -->
                        {% if rec.decision_trace %}
                        <details class="decision-trace">
                            <summary><strong>Decision Trace (Why this recommendation was made)</strong></summary>
                            <div class="trace-content">
                                {% if rec.decision_trace.triggered_signals %}
                                <h6>‚≠ê Signal That Triggered This Recommendation:</h6>
                                <p><strong>Signal ID(s):</strong> {{ rec.decision_trace.triggered_signals|join(', ') if rec.decision_trace.triggered_signals is iterable and rec.decision_trace.triggered_signals is not string else rec.decision_trace.triggered_signals }}</p>
                                {% if rec.decision_trace.input_signals and rec.decision_trace.input_signals.triggered_signal %}
                                <p><strong>Signal Name:</strong> {{ rec.decision_trace.input_signals.signal_name }}</p>
                                {% endif %}
                                {% if rec.decision_trace.signal_context %}
                                <h6>Signal Context:</h6>
                                <pre>{{ rec.decision_trace.signal_context|tojson }}</pre>
                                {% endif %}
                                {% elif rec.decision_trace.input_signals and rec.decision_trace.input_signals.persona_signals %}
                                <h6>Persona-Based Recommendation (No Specific Signal):</h6>
                                <p><em>This recommendation was generated based on persona assignment, not a specific signal trigger.</em></p>
                                <h6>Persona Signals Used:</h6>
                                <pre>{{ rec.decision_trace.input_signals.persona_signals|tojson }}</pre>
                                {% elif rec.decision_trace.input_signals %}
                                <h6>Signals Used:</h6>
                                <pre>{{ rec.decision_trace.input_signals|tojson }}</pre>
                                {% endif %}
                                
                                {% if rec.decision_trace.base_data %}
                                <h6>‚≠ê User Data That Generated These Signals:</h6>
                                <div class="base-data-section">
                                    {% if rec.decision_trace.base_data.accounts %}
                                    <h7>Accounts:</h7>
                                    <pre>{{ rec.decision_trace.base_data.accounts|tojson }}</pre>
                                    {% endif %}
                                    
                                    {% if rec.decision_trace.base_data.transactions %}
                                    <h7>Transactions ({{ rec.decision_trace.base_data.transactions|length }}):</h7>
                                    <pre>{{ rec.decision_trace.base_data.transactions|tojson }}</pre>
                                    {% endif %}
                                    
                                    {% if rec.decision_trace.base_data.liabilities %}
                                    <h7>Liabilities:</h7>
                                    <pre>{{ rec.decision_trace.base_data.liabilities|tojson }}</pre>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                {% if rec.decision_trace.offer_id %}
                                <h6>Offer ID:</h6>
                                <p>{{ rec.decision_trace.offer_id }}</p>
                                {% endif %}
                                
                                {% if rec.decision_trace.variables_inserted %}
                                <h6>Variables Inserted:</h6>
                                <pre>{{ rec.decision_trace.variables_inserted|tojson }}</pre>
                                {% endif %}
                                
                                {% if rec.decision_trace.eligibility_checks %}
                                <h6>Eligibility Checks:</h6>
                                <pre>{{ rec.decision_trace.eligibility_checks|tojson }}</pre>
                                {% endif %}
                            </div>
                        </details>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if not offers and not education %}
            <p class="empty-state">No recommendations available for this user</p>
            {% endif %}
        {% else %}
            <p class="empty-state">No recommendations available for this user</p>
        {% endif %}
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle flag button clicks without page reload
    const flagButtons = document.querySelectorAll('.flag-btn');
    
    flagButtons.forEach(button => {
        button.addEventListener('click', function() {
            const recommendationId = this.getAttribute('data-recommendation-id');
            const buttonElement = this;
            
            // Disable button to prevent double-clicks
            buttonElement.disabled = true;
            buttonElement.textContent = '‚è≥ Flagging...';
            
            // Flag the recommendation via fetch
            fetch(`/flag/${recommendationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: 'reason=',
                redirect: 'manual' // Don't follow redirects automatically
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status >= 300 && response.status < 400) {
                    // Handle redirect response (for backward compatibility)
                    return { success: true };
                } else {
                    throw new Error('Failed to flag recommendation');
                }
            })
            .then(data => {
                if (data && data.success !== false) {
                    // Update the UI to show flagged status
                    const header = buttonElement.closest('.recommendation-header');
                    if (header) {
                        buttonElement.remove();
                        const badge = document.createElement('span');
                        badge.className = 'badge badge-flagged';
                        badge.textContent = 'Flagged';
                        header.appendChild(badge);
                    }
                } else {
                    throw new Error(data.error || 'Failed to flag recommendation');
                }
            })
            .catch(error => {
                console.error('Error flagging recommendation:', error);
                buttonElement.disabled = false;
                buttonElement.textContent = 'üö© Flag for Review';
                alert('Failed to flag recommendation. Please try again.');
            });
        });
    });
    
    // Handle unflag button clicks (change approved/rejected back to flagged)
    const unflagButtons = document.querySelectorAll('.unflag-btn');
    
    unflagButtons.forEach(button => {
        button.addEventListener('click', function() {
            const recommendationId = this.getAttribute('data-recommendation-id');
            const buttonElement = this;
            const card = this.closest('.recommendation-card');
            
            // Disable button to prevent double-clicks
            buttonElement.disabled = true;
            buttonElement.textContent = '‚è≥ Flagging...';
            
            // Change status back to flagged via fetch
            fetch(`/unflag/${recommendationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                redirect: 'manual'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status >= 300 && response.status < 400) {
                    return { success: true };
                } else {
                    throw new Error('Failed to flag recommendation');
                }
            })
            .then(data => {
                if (data && data.success !== false) {
                    // Update the UI to show flagged status
                    const header = buttonElement.closest('.recommendation-header');
                    if (header) {
                        // Remove the status-actions div
                        const statusActions = header.querySelector('.status-actions');
                        if (statusActions) {
                            statusActions.remove();
                        }
                        // Add flag button
                        const flagBtn = document.createElement('button');
                        flagBtn.type = 'button';
                        flagBtn.className = 'btn btn-warning btn-sm flag-btn';
                        flagBtn.setAttribute('data-recommendation-id', recommendationId);
                        flagBtn.textContent = 'üö© Flag for Review';
                        header.appendChild(flagBtn);
                        
                        // Re-attach event listener to the new flag button
                        flagBtn.addEventListener('click', function() {
                            const recId = this.getAttribute('data-recommendation-id');
                            const btnElement = this;
                            btnElement.disabled = true;
                            btnElement.textContent = '‚è≥ Flagging...';
                            
                            fetch(`/flag/${recId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'Accept': 'application/json'
                                },
                                body: 'reason=',
                                redirect: 'manual'
                            })
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                } else if (response.status >= 300 && response.status < 400) {
                                    return { success: true };
                                } else {
                                    throw new Error('Failed to flag recommendation');
                                }
                            })
                            .then(data => {
                                if (data && data.success !== false) {
                                    btnElement.remove();
                                    const badge = document.createElement('span');
                                    badge.className = 'badge badge-flagged';
                                    badge.textContent = 'Flagged';
                                    header.appendChild(badge);
                                } else {
                                    throw new Error(data.error || 'Failed to flag recommendation');
                                }
                            })
                            .catch(error => {
                                console.error('Error flagging recommendation:', error);
                                btnElement.disabled = false;
                                btnElement.textContent = 'üö© Flag for Review';
                                alert('Failed to flag recommendation. Please try again.');
                            });
                        });
                        
                        // Remove rejection reason if it exists
                        const rejectionReason = card.querySelector('.rejection-reason-box');
                        if (rejectionReason) {
                            const rejectionHeading = rejectionReason.previousElementSibling;
                            if (rejectionHeading && rejectionHeading.tagName === 'H5' && rejectionHeading.textContent.includes('Rejection Reason')) {
                                rejectionHeading.remove();
                            }
                            rejectionReason.remove();
                        }
                    }
                } else {
                    throw new Error(data.error || 'Failed to flag recommendation');
                }
            })
            .catch(error => {
                console.error('Error flagging recommendation:', error);
                buttonElement.disabled = false;
                buttonElement.textContent = 'üîÑ Flag for Review';
                alert('Failed to flag recommendation. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}

