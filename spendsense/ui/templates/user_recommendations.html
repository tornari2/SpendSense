<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Example User View - SpendSense</title>
    <link rel="stylesheet" href="/static/css/style.css?v=2">
</head>
<body class="user-view">
    <nav class="navbar user-navbar">
        <div class="nav-container">
            <h1 class="nav-title">SpendSense</h1>
            <div class="nav-right-section">
                <ul class="nav-menu">
                    <li><a href="/users">Users</a></li>
                    <li><a href="/review">Review</a></li>
                    <li><a href="/evaluation">Evaluation</a></li>
                    <li><a href="/user-view/user_0001" class="active">Example User View</a></li>
                </ul>
                <div class="user-nav-controls">
                    <span class="user-name">{{ user.name }}</span>
                    <label class="consent-toggle-label">
                        <span class="consent-toggle-text">Consent</span>
                        <span class="consent-toggle-wrapper">
                            <input type="checkbox" id="consentToggle" class="consent-toggle" {% if user.consent_status %}checked{% endif %} data-user-id="{{ user.user_id }}">
                            <span class="consent-toggle-slider"></span>
                        </span>
                    </label>
                </div>
            </div>
        </div>
    </nav>
    
    <main class="main-content user-main-content">
        <div class="user-recommendations-page">
            {% if not has_consent %}
            <div class="no-consent-message">
                <h2>Consent Required</h2>
                <p>To view your personalized financial recommendations, please provide your consent using the toggle in the navigation bar above.</p>
                <p>If you have already consented, recommendations will appear here once they are generated.</p>
            </div>
            {% elif not recommendations %}
            <div class="no-recommendations-message">
                <h2>No Recommendations Available</h2>
                <p>We don't have any recommendations for you at this time. Recommendations will appear here once they are generated based on your financial activity.</p>
            </div>
            {% else %}
            <!-- Stacked Recommendations Layout -->
            <div class="recommendations-stacked">
                {% for rec in recommendations %}
                <div class="recommendation-card user-recommendation-card" data-recommendation-id="{{ rec.recommendation_id }}">
                    <button class="delete-recommendation-btn-small" onclick="deleteRecommendation('{{ rec.recommendation_id }}', this)" title="Remove this recommendation">
                        Ã—
                    </button>
                    <div class="recommendation-content">
                        <div class="content-box recommendation-content-text">
                            {{ rec.content|markdown|safe }}
                        </div>
                        
                        <div class="recommendation-rationale">
                            <h4>Why this recommendation?</h4>
                            <p>{{ rec.rationale }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </main>
    
    <footer class="footer user-footer">
        <p>SpendSense v1.0.0 | <a href="/users" style="color: white; text-decoration: underline;">Operator View</a></p>
    </footer>

    <script>
        // Ensure page always reloads fresh data, especially after POST operations
        // This prevents browser from showing cached content when using back button
        window.addEventListener('pageshow', function(event) {
            // If page was loaded from cache (back button), reload to get fresh data
            if (event.persisted) {
                window.location.reload();
            }
        });
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Handle consent toggle switch
            const consentToggle = document.getElementById('consentToggle');
            
            if (consentToggle) {
                consentToggle.addEventListener('change', function() {
                    const consentStatus = this.checked;
                    const formData = new FormData();
                    formData.append('consent_status', consentStatus);
                    
                    fetch('/user-view/{{ user.user_id }}/consent', {
                        method: 'POST',
                        body: formData
                    }).then(() => {
                        location.reload();
                    }).catch(err => {
                        console.error('Error updating consent:', err);
                    });
                });
            }
        });
        
        // Delete recommendation with smooth animation
        function deleteRecommendation(recommendationId, buttonElement) {
            const card = buttonElement.closest('.user-recommendation-card');
            if (!card) return;
            
            // Get the card's height for smooth collapse animation
            const cardHeight = card.offsetHeight;
            const cardMargin = parseInt(window.getComputedStyle(card).marginBottom) || 0;
            const totalHeight = cardHeight + cardMargin;
            
            // Add transition for smooth slide-up and fade
            card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, max-height 0.3s ease-out, margin-bottom 0.3s ease-out';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-10px) scale(0.95)';
            card.style.maxHeight = cardHeight + 'px';
            card.style.overflow = 'hidden';
            card.style.marginBottom = '0';
            
            // Collapse the card height
            setTimeout(() => {
                card.style.maxHeight = '0';
                card.style.paddingTop = '0';
                card.style.paddingBottom = '0';
            }, 50);
            
            // Delete via API
            fetch(`/user-view/{{ user.user_id }}/recommendations/${recommendationId}/delete`, {
                method: 'POST'
            }).then(() => {
                // Wait for animation to complete, then remove element
                setTimeout(() => {
                    card.remove();
                }, 350);
            }).catch(err => {
                console.error('Error deleting recommendation:', err);
                // Reset card on error
                card.style.opacity = '1';
                card.style.transform = 'translateY(0) scale(1)';
                card.style.maxHeight = '';
                card.style.overflow = '';
                card.style.marginBottom = '';
                card.style.paddingTop = '';
                card.style.paddingBottom = '';
                alert('Failed to delete recommendation. Please try again.');
            });
        }
    </script>
</body>
</html>
