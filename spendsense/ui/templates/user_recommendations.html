<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>My Recommendations - SpendSense</title>
    <link rel="stylesheet" href="/static/css/style.css?v=2">
</head>
<body class="user-view">
    <nav class="navbar user-navbar">
        <div class="nav-container">
            <h1 class="nav-title">SpendSense</h1>
            <div class="user-nav-controls">
                <span class="user-name">{{ user.name }}</span>
                <label class="consent-toggle-label">
                    <span class="consent-toggle-text">Consent</span>
                    <span class="consent-toggle-wrapper">
                        <input type="checkbox" id="consentToggle" class="consent-toggle" {% if user.consent_status %}checked{% endif %} data-user-id="{{ user.user_id }}">
                        <span class="consent-toggle-slider"></span>
                    </span>
                </label>
            </div>
        </div>
    </nav>
    
    <main class="main-content user-main-content">
        <div class="user-recommendations-page">
            {% if not has_consent %}
            <div class="no-consent-message">
                <h2>Consent Required</h2>
                <p>To view your personalized financial recommendations, please provide your consent using the toggle in the navigation bar above.</p>
                <p>If you have already consented, recommendations will appear here once they are generated.</p>
            </div>
            {% elif not recommendations %}
            <div class="no-recommendations-message">
                <h2>No Recommendations Available</h2>
                <p>We don't have any recommendations for you at this time. Recommendations will appear here once they are generated based on your financial activity.</p>
            </div>
            {% else %}
            <div class="recommendations-header">
                <h2>Your Personalized Recommendations</h2>
                <p class="recommendations-subtitle">Based on your financial activity and spending patterns</p>
            </div>
            
            {% set offers = recommendations | selectattr("type", "equalto", "offer") | list %}
            {% set education = recommendations | selectattr("type", "equalto", "education") | list %}
            
            <!-- Partner Offers Section -->
            {% if offers %}
            <section class="recommendations-section offers-section">
                <h3>Partner Offers</h3>
                <div class="offer-disclaimer">
                    <strong>Disclaimer:</strong> These offers are provided by our partner financial institutions. Please review all terms and conditions before accepting any offer.
                </div>
                
                {% for rec in offers %}
                <div class="recommendation-card user-recommendation-card">
                    <div class="recommendation-header-user">
                        <form method="post" action="/user-view/{{ user.user_id }}/recommendations/{{ rec.recommendation_id }}/delete" style="display: inline;">
                            <button type="submit" class="delete-recommendation-btn" title="Remove this recommendation" onclick="return confirm('Are you sure you want to remove this recommendation?');">
                                ×
                            </button>
                        </form>
                    </div>
                    <div class="recommendation-content">
                        <div class="content-box recommendation-content-text">
                            {{ rec.content|markdown|safe }}
                        </div>
                        
                        <div class="recommendation-rationale">
                            <h4>Why this recommendation?</h4>
                            <p>{{ rec.rationale }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endif %}
            
            <!-- Educational Materials Section -->
            {% if education %}
            <section class="recommendations-section education-section">
                <h3>Educational Resources</h3>
                
                {% for rec in education %}
                <div class="recommendation-card user-recommendation-card">
                    <div class="recommendation-header-user">
                        <form method="post" action="/user-view/{{ user.user_id }}/recommendations/{{ rec.recommendation_id }}/delete" style="display: inline;">
                            <button type="submit" class="delete-recommendation-btn" title="Remove this recommendation" onclick="return confirm('Are you sure you want to remove this recommendation?');">
                                ×
                            </button>
                        </form>
                    </div>
                    <div class="recommendation-content">
                        <div class="content-box recommendation-content-text">
                            {{ rec.content|markdown|safe }}
                        </div>
                        
                        <div class="recommendation-rationale">
                            <h4>Why this recommendation?</h4>
                            <p>{{ rec.rationale }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endif %}
            {% endif %}
        </div>
    </main>
    
    <footer class="footer user-footer">
        <p>SpendSense v1.0.0 | <a href="/users" style="color: white; text-decoration: underline;">Operator View</a></p>
    </footer>

    <!-- Consent Modal - BLOCKS ENTIRE WINDOW -->
    <div id="consentModal" class="consent-modal {% if not user.consent_status %}show{% endif %}">
        <div class="consent-modal-content">
            <h2>Consent Required</h2>
            <p>To view personalized financial recommendations, please provide your consent.</p>
            <p>By clicking "I Consent", you agree to:</p>
            <ul>
                <li>Allow SpendSense to analyze your financial data</li>
                <li>Receive personalized recommendations based on your spending patterns</li>
                <li>Share your data for recommendation generation purposes</li>
            </ul>
            <div class="consent-modal-actions">
                <form method="post" action="/user-view/{{ user.user_id }}/consent" id="consentForm">
                    <input type="hidden" name="consent_status" id="consentStatusInput" value="true">
                    <button type="submit" class="btn btn-success btn-large">I Consent</button>
                    <button type="button" class="btn btn-secondary btn-large" onclick="declineConsent()">Decline</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Ensure page always reloads fresh data, especially after POST operations
        // This prevents browser from showing cached content when using back button
        window.addEventListener('pageshow', function(event) {
            // If page was loaded from cache (back button), reload to get fresh data
            if (event.persisted) {
                window.location.reload();
            }
        });
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Handle consent toggle
            const consentToggle = document.getElementById('consentToggle');
            const consentModal = document.getElementById('consentModal');
            const consentStatusInput = document.getElementById('consentStatusInput');
            
            // Show modal on page load/refresh if user hasn't consented
            // The modal should BLOCK the entire window when consent is False
            const hasConsent = {{ 'true' if user.consent_status else 'false' }};
            
            // Always show modal if user hasn't consented (blocking popup)
            if (!hasConsent && consentModal) {
                consentModal.classList.add('show');
                // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
            } else if (hasConsent && consentModal) {
                consentModal.classList.remove('show');
                document.body.style.overflow = '';
            }
            
            function declineConsent() {
                // Hide modal
                if (consentModal) {
                    consentModal.classList.remove('show');
                    document.body.style.overflow = '';
                }
                
                // Update consent status to false
                fetch('/user-view/{{ user.user_id }}/consent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'consent_status=false'
                }).then(() => {
                    // Redirect back to User View Selection page
                    window.location.href = '/user-view';
                }).catch(err => {
                    console.error('Error updating consent:', err);
                    // Still redirect even if there's an error
                    window.location.href = '/user-view';
                });
            }
            
            // Make declineConsent available globally
            window.declineConsent = declineConsent;
            
            // Handle consent form submission
            const consentForm = document.getElementById('consentForm');
            if (consentForm) {
                consentForm.addEventListener('submit', function() {
                    // Allow form to submit normally - page will reload after consent
                    document.body.style.overflow = '';
                });
            }
            
            // Handle consent toggle switch
            if (consentToggle) {
                consentToggle.addEventListener('change', function() {
                    const consentStatus = this.checked;
                    const formData = new FormData();
                    formData.append('consent_status', consentStatus);
                    
                    if (consentStatus && consentModal) {
                        // Hide modal when consent is granted
                        consentModal.classList.remove('show');
                        document.body.style.overflow = '';
                    } else if (!consentStatus && consentModal) {
                        // Show modal when consent is revoked
                        consentModal.classList.add('show');
                        document.body.style.overflow = 'hidden';
                    }
                    
                    fetch('/user-view/{{ user.user_id }}/consent', {
                        method: 'POST',
                        body: formData
                    }).then(() => {
                        location.reload();
                    }).catch(err => {
                        console.error('Error updating consent:', err);
                    });
                });
            }
        });
    </script>
</body>
</html>
